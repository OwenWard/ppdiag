---
title: "`ppdiag`, diagnostic tools for temporal Point Processes"
output: rmarkdown::html_vignette
author: Sally Sun, Owen G. Ward, Xiaoxi Zhao, Jing Wu, Tian Zheng.
vignette: >
  %\VignetteIndexEntry{`ppdiag`, diagnostic tools for temporal Point Processes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(100) # to make it reproducible
```

```{r setup}
library(ppdiag)
```

This vignette provides an introduction to the functions 
available in `ppdiag` to evaluate the fit of univariate temporal 
point processes.

To achieve this, we currently include a range of functions which allow
a user to:

- Simulate data from a range of common univariate point processes.
- Fit a range of univariate point processes to data.
- After fitting a point process to some data, evaluate the ability of that 
point process to capture the temporal structure present in this data.

## Classes
- Homogeneous Poisson Process: 

`hpp(lambda, start=0, end=1, n = NULL)` creates an object of
a list type in class 'hpp'. 
```{r}
hpp_obj <- pp_hpp(lambda = 1)
hpp_obj
```

- Hawkes Process: 

`hp(lambda0, alpha, beta, events = NULL)` creates an object of list 
type in class 'hp'.
```{r}
hp_obj <- pp_hp(lambda0 = 0.1,alpha = 0.45,beta = 0.5)
hp_obj
```

- Markov-Modulated Hawkes Process: 

`mmhp(lambda0, lambda1, alpha, beta, Q = NULL, delta = NULL, events = NULL)` 
creates an object of type in class 'mmhp'. 
```{r}
Q <- matrix(c(-0.4, 0.4, 0.2, -0.2), ncol = 2, byrow = TRUE)

mmhp_obj <- pp_mmhp(Q, delta = c(1 / 3, 2 / 3), 
          lambda0 = 0.2,
          lambda1 = .75,
          alpha = 0.1,
          beta = 0.2)

mmhp_obj

```

## Simulating data
Functions for simulating data is pp_simulate, which take in model and objects of type `hpp`, `hp`, and `mmhp`,
respectively, with additional parameters for simulation, and produces a vector
of simulated event times. 

- Homogeneous Poisson Process: 

`pp_simulate` takes a hpp object and returns a vector of event times
simulated from the corresponding homogeneous Poisson process.
<!-- In the hpp object, one can either specify n, 
which is expected number of  -->
<!-- events, or end, which is the expected end time of event times. If both 
are  -->
<!-- provided, then the function will automatically simulate n events 
regardless of -->
<!-- the end time specified.  -->

`pp_simulate(pp_obj, start=0, end=NULL, n=NULL)` can simulate events up to a specified end time.
```{r}
hpp_events <- pp_simulate(hpp_obj, end=10)
hpp_events
```

or specify a vector of certain length.
```{r}
pp_simulate(hpp_obj, end=10, n=5)
```

- Hawkes Process: 

`pp_simulate(hp_obj, end=NULL, n=NULL)` returns event times
simulated from the Hawkes process specified by `hp`, up to some end
time, along with the maximum overall intensity of the Hawkes process
given these events.
```{r}
hp_events <- pp_simulate(hp_obj, start = 0, end = 50)
hp_events
```

You can also specify desired length of events. 
```{r}
hp_events <- pp_simulate(hp_obj, start = 0, end = 50, n=10)
hp_events
```

- Markov-Modulated Hawkes Process: 

`pp_simulate(mmhp_obj, n=NULL, end=NULL)` 
simulates events from a specified Markov Modulated Hawkes process. 
```{r}
mmhp_events <- pp_simulate(mmhp_obj, n = 50)
mmhp_events
```



## Fitting a point process
Functions for fitting objects include fithpp and fithp, which take in event times and produce object of type hpp and hp, respectively. 

- Homogeneous Poisson Process: 

`fithpp(hpp_events)` returns an object of class `hpp`.

```{r}
fit_hpp <- fithpp(hpp_events)
fit_hpp
```

- Hawkes Process: 

`fithp(vec,t,end)` returns an object of class `hp`, estimating the
three parameters of the Hawkes process using `optim`, with the initial
value given by `vec`. This can be a challenging optimisation problem
and convergence is not guaranteed.
```{r}
init <- rep(0.1,3)
fit_hp <- fithp(init, hp_events$events)
fit_hp
```

## Diagnosing the fit of a point process to data

There are several existing methods which can be used to assess the goodness of fit of a point process to temporal data. In this package we allow a user to:

- Examine the distribution of the rescaled interevent times, by utilising the
time rescaling theorem.
- Examine the residual process of an estimated point process, 
in particular computing the raw and Pearson residuals for a given point 
process fit to data.
- Visually inspect the estimated intensity of the point process.

<!-- `drawHPPIntensity(hpp, events = NULL, color = "red",  -->
<!-- plot_events = FALSE, -->
<!-- fit = FALSE, int_title = "Intensity homogeneous Poisson Process")` -->
<!-- plots the intensity of a homogeneous poisson process.  -->

<!-- To plot the simulated events with the intensity, specify plot_events=FALSE.  -->
<!-- ```{r} -->
<!-- drawHPPIntensity(fit_hpp, events = hpp_events, color = "red", -->
<!--                  plot_events = FALSE) -->
<!-- ``` -->


### Visualize the intensity function

`drawHPPIntensity(hpp, events, color = "red", start = 0, end = max(events), fit=FALSE, int_title = "Intensity homogeneous Poisson Process")` plots the intensity of a homogeneous poisson process. To plot the events along with intensity, set plot_events=TRUE. 
```{r,fig.width=4,fig.height=4}
drawHPPIntensity(fit_hpp, events = hpp_events,
                 color = "red", plot_events=TRUE)
```

To plot the fitted intensity on the inputted events, specify fit=TRUE.
```{r,fig.width=4,fig.height=4}
drawHPPIntensity(fit_hpp, events=hp_events$events,
                 color = "red", fit=TRUE, plot_events=TRUE)
```

You can also plot the event time counts for the homogeneous poisson process. 
```{r,fig.width=4,fig.height=4}
plothpp_step(pp_simulate(hpp_obj, end = 10, n=50))
```

`drawHPIntensity(hp, start = 0, end = max(events), history=0, events, color = 1, i = 1, add=FALSE, fit=FALSE, vec=rep(0.1,3), int_title="Hawkes Intensity")` plots the intensity of a hawkes process. To plot the events along with intensity, set `plot_events=TRUE`. 
```{r,fig.width=4,fig.height=5}
drawHPIntensity(fit_hp, start = min(hp_events$events), 
                end = max(hp_events$events), history = 0,
                events = hp_events$events, plot_events = TRUE)
```

To plot the fitted intensity on the inputted events, set fit=TRUE.
```{r,fig.width=4,fig.height=5}
drawHPIntensity(fit_hp, start = min(hp_events$events), end = max(hp_events$events),
                history = 0, events = hp_events$events, fit=TRUE, plot_events=TRUE)
```

`drawUniMMHPIntensity(mmhp, simulation, add = FALSE, fit=FALSE, 
color = 1, int_title = "Intensity Plot of MMHP")` plots the intensity of a 
mmhp process. 
```{r,fig.width=4,fig.height=5}
drawUniMMHPIntensity(mmhp_obj, mmhp_events)
```



### Diagnostics tools of the models

- Homogeneous Poisson Process

`diagpp(object, events, pzt = NULL)` gives diagnostics of the model,
including a qq plot, a ks plot, ks test, raw
and pearson residuals in one function.

```{r,fig.width=7,fig.height=4}
diagpp(hpp_obj,hpp_events)
```

`rawresidual(object, events, start = min(events),end = max(events))` gives rawresidual only. 

```{r}
rawresidual(hpp_obj,hpp_events)
```

`pearsonresidual(object, events, start = min(events),end = max(events))` gives pearsonresidual only. 

```{r}
pearsonresidual(hpp_obj,hpp_events)
```

`intensityqqplot(object, events)` gives both qqplot and intensity plot. 

```{r,fig.width=7,fig.height=4}
intensityqqplot(hpp_obj, hpp_events)
```

- Hawkes Process

`diagpp(object, events)` gives diagnostics of the model,
including a qq plot, a ks plot, ks test, raw
and pearson residuals in one function.

```{r,fig.width=7,fig.height=4}
diagpp(hp_obj,hp_events$events)
```

`rawresidual(object, events, start = min(events),end = max(events))` gives rawresidual only. 

```{r}
rawresidual(hp_obj,hp_events$events)
```

`pearsonresidual(object, events, start = min(events),end = max(events))` gives pearsonresidual only. 

```{r}
pearsonresidual(hp_obj,hp_events$events)
```

`intensityqqplot(object, events)` gives both qqplot and intensity plot. 

```{r,fig.width=7,fig.height=4}
intensityqqplot(hp_obj, hp_events$events)
```


### MMHP


```{r,fig.width=7,fig.height=4}
diagpp(mmhp_obj,mmhp_events$events)
```

